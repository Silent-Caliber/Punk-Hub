--[[ 
    PUNK X HUB - PROFESSIONAL KEY SYSTEM
    Optimized & Fixed by AI
]]

-- // Services
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local StarterGui = game:GetService("StarterGui")

-- // Configuration
local Config = {
    ServiceID = "punk-x-release-key",
    HubScript = "https://raw.githubusercontent.com/GBMofo/Punk-Hub/main/The-Forge",
    FileName = "PunkXHub_Key.txt", -- Specific file name
    Theme = {
        Background = Color3.fromRGB(46, 46, 46),
        Accent = Color3.fromRGB(42, 172, 248),
        Text = Color3.fromRGB(255, 255, 255)
    }
}

-- // Load Dependency (Pelinda)
if not getgenv().Pelinda then
    local success, err = pcall(function()
        getgenv().Pelinda = loadstring(game:HttpGet("https://raw.githubusercontent.com/Pelinwach/Pelinda/main/Library.lua"))()
    end)
    if not success then 
        warn("Failed to load Key System Library:", err) 
        return 
    end
end

-- // Helper Functions
local function Notify(title, text, duration)
    StarterGui:SetCore("SendNotification", {
        Title = title;
        Text = text;
        Duration = duration or 3;
    })
end

local function LoadHub()
    local success, err = pcall(function()
        loadstring(game:HttpGet(Config.HubScript))()
    end)
    if not success then Notify("Error", "Failed to load Hub: " .. tostring(err), 5) end
end

local function SaveKey(key)
    writefile(Config.FileName, key)
end

local function ReadKey()
    if isfile(Config.FileName) then
        return readfile(Config.FileName)
    end
    return nil
end

-- // UI Creation
local function CreateUI()
    -- Destroy existing UI if present
    if CoreGui:FindFirstChild("PunkXKeySystem") then
        CoreGui.PunkXKeySystem:Destroy()
    end

    local ScreenGui = Instance.new("ScreenGui")
    local MainFrame = Instance.new("Frame")
    local UICorner = Instance.new("UICorner")
    local BackgroundImage = Instance.new("ImageLabel")
    local Title = Instance.new("TextLabel")
    local SubTitle = Instance.new("TextLabel")
    
    local InputFrame = Instance.new("Frame")
    local InputCorner = Instance.new("UICorner")
    local InputStroke = Instance.new("UIStroke")
    local InputBox = Instance.new("TextBox")
    local KeyIcon = Instance.new("ImageLabel")
    
    local GetKeyBtn = Instance.new("TextButton")
    local GetKeyCorner = Instance.new("UICorner")
    local GetKeyStroke = Instance.new("UIStroke")
    
    local RedeemBtn = Instance.new("TextButton")
    local RedeemCorner = Instance.new("UICorner")
    local RedeemStroke = Instance.new("UIStroke")

    -- Properties
    ScreenGui.Name = "PunkXKeySystem"
    ScreenGui.Parent = CoreGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.IgnoreGuiInset = true

    MainFrame.Name = "MainFrame"
    MainFrame.Parent = ScreenGui
    MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    MainFrame.BackgroundColor3 = Config.Theme.Background
    MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    MainFrame.Size = UDim2.new(0, 0, 0, 0) -- Start small for animation
    MainFrame.ClipsDescendants = true

    UICorner.CornerRadius = UDim.new(0, 12)
    UICorner.Parent = MainFrame

    BackgroundImage.Parent = MainFrame
    BackgroundImage.AnchorPoint = Vector2.new(0.5, 0.5)
    BackgroundImage.BackgroundTransparency = 1
    BackgroundImage.Position = UDim2.new(0.5, 0, 0.5, 0)
    BackgroundImage.Size = UDim2.new(1, 0, 1, 0)
    BackgroundImage.Image = "rbxassetid://8992230677"
    BackgroundImage.ImageTransparency = 0.6
    BackgroundImage.ImageColor3 = Color3.new(0,0,0)
    BackgroundImage.ScaleType = Enum.ScaleType.Slice
    BackgroundImage.SliceCenter = Rect.new(99, 99, 99, 99)

    Title.Name = "Title"
    Title.Parent = MainFrame
    Title.BackgroundTransparency = 1
    Title.Position = UDim2.new(0.05, 0, 0.05, 0)
    Title.Size = UDim2.new(0.9, 0, 0.2, 0)
    Title.Font = Enum.Font.RobotoCondensed
    Title.Text = "Welcome to PUNK X HUB"
    Title.TextColor3 = Config.Theme.Text
    Title.TextSize = 28
    Title.TextXAlignment = Enum.TextXAlignment.Left

    SubTitle.Name = "SubTitle"
    SubTitle.Parent = MainFrame
    SubTitle.BackgroundTransparency = 1
    SubTitle.Position = UDim2.new(0, 0, 0.25, 0)
    SubTitle.Size = UDim2.new(1, 0, 0.15, 0)
    SubTitle.Font = Enum.Font.FredokaOne
    SubTitle.Text = "KEY SYSTEM"
    SubTitle.TextColor3 = Config.Theme.Accent
    SubTitle.TextSize = 32

    -- Input Area
    InputFrame.Name = "InputFrame"
    InputFrame.Parent = MainFrame
    InputFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    InputFrame.Position = UDim2.new(0.05, 0, 0.5, 0)
    InputFrame.Size = UDim2.new(0.9, 0, 0.2, 0)

    InputCorner.CornerRadius = UDim.new(0, 8)
    InputCorner.Parent = InputFrame

    InputStroke.Parent = InputFrame
    InputStroke.Color = Color3.fromRGB(255, 255, 255)
    InputStroke.Transparency = 0.8
    InputStroke.Thickness = 1
    InputStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

    InputBox.Parent = InputFrame
    InputBox.BackgroundTransparency = 1
    InputBox.Position = UDim2.new(0.12, 0, 0, 0)
    InputBox.Size = UDim2.new(0.88, 0, 1, 0)
    InputBox.Font = Enum.Font.SourceSans
    InputBox.PlaceholderText = "Enter your license key..."
    InputBox.Text = ""
    InputBox.TextColor3 = Color3.fromRGB(220, 220, 220)
    InputBox.TextSize = 18
    InputBox.TextXAlignment = Enum.TextXAlignment.Left

    KeyIcon.Parent = InputFrame
    KeyIcon.BackgroundTransparency = 1
    KeyIcon.Position = UDim2.new(0.02, 0, 0.15, 0)
    KeyIcon.Size = UDim2.new(0, 28, 0, 28)
    KeyIcon.Image = "rbxassetid://10723416652"

    -- Buttons
    GetKeyBtn.Name = "GetKey"
    GetKeyBtn.Parent = MainFrame
    GetKeyBtn.BackgroundColor3 = Color3.fromRGB(38, 38, 38)
    GetKeyBtn.Position = UDim2.new(0.05, 0, 0.75, 0)
    GetKeyBtn.Size = UDim2.new(0.42, 0, 0.2, 0)
    GetKeyBtn.Font = Enum.Font.SourceSansBold
    GetKeyBtn.Text = "Get Key"
    GetKeyBtn.TextColor3 = Config.Theme.Accent
    GetKeyBtn.TextSize = 20

    GetKeyCorner.CornerRadius = UDim.new(0, 8)
    GetKeyCorner.Parent = GetKeyBtn
    
    GetKeyStroke.Parent = GetKeyBtn
    GetKeyStroke.Color = Config.Theme.Accent
    GetKeyStroke.Transparency = 0.5
    GetKeyStroke.Thickness = 1
    GetKeyStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

    RedeemBtn.Name = "Redeem"
    RedeemBtn.Parent = MainFrame
    RedeemBtn.BackgroundColor3 = Config.Theme.Accent
    RedeemBtn.Position = UDim2.new(0.53, 0, 0.75, 0)
    RedeemBtn.Size = UDim2.new(0.42, 0, 0.2, 0)
    RedeemBtn.Font = Enum.Font.SourceSansBold
    RedeemBtn.Text = "Redeem"
    RedeemBtn.TextColor3 = Color3.WHITE
    RedeemBtn.TextSize = 20

    RedeemCorner.CornerRadius = UDim.new(0, 8)
    RedeemCorner.Parent = RedeemBtn

    -- Draggable Logic (Improved)
    local dragging, dragInput, dragStart, startPos
    local function update(input)
        local delta = input.Position - dragStart
        local newPos = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        MainFrame.Position = newPos
    end
    MainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    MainFrame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then update(input) end
    end)

    -- Animations
    TweenService:Create(MainFrame, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = UDim2.new(0, 400, 0, 200)}):Play()

    local function ButtonAnim(btn)
        btn.MouseButton1Down:Connect(function()
            TweenService:Create(btn, TweenInfo.new(0.1), {Size = UDim2.new(btn.Size.X.Scale * 0.95, 0, btn.Size.Y.Scale * 0.95, 0)}):Play()
        end)
        btn.MouseButton1Up:Connect(function()
            TweenService:Create(btn, TweenInfo.new(0.1), {Size = UDim2.new(btn.Size.X.Scale / 0.95, 0, btn.Size.Y.Scale / 0.95, 0)}):Play()
        end)
        btn.MouseLeave:Connect(function()
            TweenService:Create(btn, TweenInfo.new(0.1), {Size = UDim2.new(btn.Size.X.Scale, 0, btn.Size.Y.Scale, 0)}):Play() -- Reset safety
        end)
    end
    ButtonAnim(GetKeyBtn)
    ButtonAnim(RedeemBtn)

    -- Logic
    GetKeyBtn.MouseButton1Click:Connect(function()
        local success, link = pcall(function()
            return Pelinda.GetKeyLink(Config.ServiceID)
        end)
        
        if success and link then
            setclipboard(link)
            Notify("PUNK X HUB", "Link copied to clipboard!", 3)
            GetKeyBtn.Text = "Copied!"
            task.wait(2)
            GetKeyBtn.Text = "Get Key"
        else
            Notify("Error", "Failed to generate link.", 3)
        end
    end)

    RedeemBtn.MouseButton1Click:Connect(function()
        local key = InputBox.Text
        if key == "" then return end

        RedeemBtn.Text = "Checking..."
        local status
        local success, err = pcall(function()
            status = Pelinda.Init({
                Service = Config.ServiceID,
                SilentMode = true,
                Key = key,
                SecurityLevel = 1
            })
        end)

        if success and status == "validated!!" then
            SaveKey(key)
            Notify("Success", "Key Validated!", 3)
            TweenService:Create(MainFrame, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In), {Size = UDim2.new(0,0,0,0)}):Play()
            task.wait(0.4)
            ScreenGui:Destroy()
            LoadHub()
        else
            RedeemBtn.Text = "Redeem"
            InputBox.Text = ""
            InputBox.PlaceholderText = "Invalid Key"
            task.wait(2)
            InputBox.PlaceholderText = "Enter your license key..."
        end
    end)
end

-- // Main Auto-Check Logic
task.spawn(function()
    local savedKey = ReadKey()
    
    if savedKey then
        -- Optional: Show a small "Verifying" toast notification here
        Notify("PUNK X HUB", "Verifying saved key...", 2)
        
        local status
        local success = pcall(function()
            status = Pelinda.Init({
                Service = Config.ServiceID,
                SilentMode = true,
                Key = savedKey:gsub("%s+", ""), -- Clean whitespace
                SecurityLevel = 1
            })
        end)

        if success and status == "validated!!" then
            Notify("PUNK X HUB", "Welcome back!", 3)
            LoadHub()
        else
            CreateUI()
        end
    else
        CreateUI()
    end
end)
